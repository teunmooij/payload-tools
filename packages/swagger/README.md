[![created by](https://img.shields.io/badge/author-Teun%20Mooij-blue)](https://www.linkedin.com/in/teunmooij/)
[![snyk](https://snyk.io/test/github/teunmooij/payload-tools/badge.svg)](https://snyk.io/test/github/teunmooij/payload-tools)
[![downloads](https://img.shields.io/npm/dt/payload-swagger?color=blue)](https://www.npmjs.com/package/payload-swagger)
[![npm version](https://badge.fury.io/js/payload-swagger.svg)](https://www.npmjs.com/package/payload-swagger)
[![license](https://img.shields.io/npm/l/payload-swagger?color=blue)](https://img.shields.io/npm/l/payload-swagger)

# payload-swagger

Swagger plugin for payload cms:

- generate openAPI 3 documentation from your payload config
- adds routes for:
  - openAPI document
  - Swagger UI
  - LICENSE file, if available

`payload-swagger` uses `payload-openapi`, which documents ALL your payload openapi endpoints and includes:

- collection endpoints
- global endpoints
- custom endpoints
- authentication endpoints
- preferences endpoints
- fully typed schema definitions for all requests, parameters and responses
- authentication requirements for all your endpoints
- extension points to merge your custom openapi definitions into the schema

Alternatives:

- [payload-openapi](https://www.npmjs.com/package/payload-openapi) if you just want to openapi document
- [create-payload-api-docs](https://www.npmjs.com/package/create-payload-api-docs) if you want a cli version (eg to build the openapi doc in your build pipeline)

## Installation

With yarn:

```shell
yarn add payload-swagger
```

With npm:

```shell
npm install payload-swagger
```

## Usage

```typescript
import { buildConfig } from 'payload/config';
import path from 'path';
import { swagger } from 'payload-swagger';

export default buildConfig({
  plugins: [
    swagger({
      /* see options section */
    }),
  ],
  // The rest of your config goes here
});
```

## Extend the openAPI document

The openAPI document generated by `payload-swagger` includes information from the following external sources:

- `package.json`: `payload-swagger` uses the information in the fields shown below. In `openapi` a partial openapi document can be included;

```json
{
  "name": "my payload cms",
  "version": "1.2.3",
  "description": "My awesome cms",
  "license": "MIT",
  "openapi": {}
}
```

- `.openapi`: optional file with partial openapi document in JSON format.

The data from all these source is recursively merged into the final document.

## Options

`payload-swagger` has the following options:

```typescript
interface Options {
  /**
   * By default the access functions on all collections in the config are called to determine
   * the access level of the operations.
   * Provide an array of collection slugs to disable this for the given collections,
   * or `true` to disable for all.
   */
  disableAccessAnalysis?: boolean | string[];

  /**
   * Exclude parts of the payload config from the openapi document
   */
  exclude?: {
    authPaths?: boolean;
    authCollection?: boolean;
    passwordRecovery: boolean; // default true, set to `false` to include
    preferences?: boolean; // default true, set to `false` to include
    custom?: boolean;
  };

  /**
   * Customize the payload-swagger routes
   */
  routes?: {
    /**
     * Swagger ui route
     * @default /api-docs
     */
    swagger?: string;
    /**
     * Openapi specs route
     * @default /api-docs/specs
     */
    specs?: string;
    /**
     * License route (requires LICENSE file in root of repository or explicit license url in openapi document)
     * @default /api-docs/license
     */
    license?: string;
  };

  /**
   * Swagger ui options (see swagger-ui documentation)
   */
  ui?: Omit<SwaggerUiOptions, 'swaggerUrl' | 'swaggerUrls'>;

  /**
   * Throw on error
   * @default false
   * @description If set to true, the plugin will throw the error if any error occurs while generating the openapi document, causing Payload to fail to start.
   */
  throwOnError?: boolean;
}
```

## Descriptions

Endpoint descriptions and summaries are generated from the `description` and `label`/`labels.{singular/plural}` fields of your globals and collections. If a multilanguage (`Record<string, string>) value is found, the order of priority for picking the language is as follows:

- docs
- en
- first value found that is a string

This makes it possible to set a custom description for the docs:

```ts
import { CollectionConfig } from 'payload/types';

const Media: CollectionConfig = {
  slug: 'media',
  admin: {
    description: {
      docs: 'Description used in openapi docs',
      en: 'Description used in the admin panel',
    },
  },
  labels: {
    singular: 'Single value used everywhere',
    plural: {
      docs: 'Plural value used in docs',
      en: 'Plural value used in admin panel',
    },
  },
  // ... Rest of collection config
};
```

## Documentation of custom endpoints

Custom endpoints on all levels can be fully documented, either by using the `defineEndpoint` helper:

```ts
import { CollectionConfig } from 'payload/types';
import { defineEndpoint } from 'payload-swagger';

const Post: CollectionConfig = {
  slug: 'posts',
  endpoints: [
    defineEndpoint({
      summary: 'media by category',
      description: 'gets the media of the given category',
      path: '/category/:category',
      method: 'get',
      responseSchema: 'posts',
      errorResponseSchemas: {
        404: 'error',
      },
      queryParameters: {
        limit: { schema: { type: 'number' } },
        page: { schema: { type: 'number' } },
        sort: { scema: { type: 'string' } },
      },
      handler: (req, res) => {
        // ... handler implementation
      },
    }),
  ],
  // ... Rest of collection config
};
```

or by setting the `custom.openapi` property:

```ts
import { CollectionConfig } from 'payload/types';
import type { EndpointDocumentation } from 'payload-swagger';

const documentation: EndpointDocumentation = {
  summary: 'media by category',
  description: 'gets the media of the given category',
  responseSchema: 'posts',
  errorResponseSchemas: {
    404: { type: 'object', properties: { message: { type: 'string' } }, required: ['message'] },
  },
  queryParameters: {
    limit: { schema: { type: 'number' } },
    page: { schema: { type: 'number' } },
    sort: { scema: { type: 'string' } },
  },
};

const Post: CollectionConfig = {
  slug: 'posts',
  endpoints: [
    {
      path: '/category/:category',
      method: 'get',
      handler: (req, res) => {
        // ... handler implementation
      },
      custom: {
        openapi: documentation,
      },
    },
  ],
  // ... Rest of collection config
};
```

Response schemas can be defined as openapi schema objects or as string, referencing any of the schemas defined in the schema section of the openapi document.

To exclude a custom endpoint from the documentation, set the `custom.openapi` property to `false`.

## Adding examples

Examples can be added on collections and globals.

This can be either a single example:

```ts
import { CollectionConfig } from 'payload/types';

const Categories: CollectionConfig = {
  slug: 'categories',
  custom: {
    openapi: {
      example: {
        name: 'Example Category',
        archived: false,
      },
    },
  },
  // ... Rest of collection config
};
```

Or multiple examples

```ts
import { CollectionConfig } from 'payload/types';

const Categories: CollectionConfig = {
  slug: 'categories',
  custom: {
    openapi: {
      examples: {
        active: {
          value: {
            name: 'Active Category',
            archived: false,
          },
          summary: 'Example of an active category',
        },
        archive: {
          value: {
            name: 'Archived Category',
            archived: true,
          },
          summary: 'Example of an archived category',
        },
      },
    },
  },
  // ... Rest of collection config
};
```

Openapi supports examples at lots of different levels. To add examples add other levels, you can define theme in a separate partial openapi document, as described [here](#extend-the-openapi-document).

## Excluding unused endpoints

In Payload `collections` and `globals` have a standard set of available endpoints. In some situations you might not want to use some of these endpoints. In those situations you probably have used an access method that looks something like this: `() => false;`. This blocks all traffic, but the endpoint is still part of the openapi documentation.

To also remove the endpoint from the openapi documentation, you can use [payload-rbac](https://www.npmjs.com/package/payload-rbac):

```ts
import { CollectionConfig } from 'payload/types';
import { blockAll } from 'payload-rbac';

const Media: CollectionConfig: {
  slug: 'media',
  access: {
    delete: blockAll(), // Use block all to exclude endpoint from docs
  },
  // ... Rest of collection config
}
```

## Version history

See [changelog](./CHANGELOG.md)
