[![author](https://img.shields.io/badge/author-Teun%20Mooij-blue)](https://www.linkedin.com/in/teunmooij/)
[![snyk](https://snyk.io/test/github/teunmooij/payload-tools/badge.svg)](https://snyk.io/test/github/teunmooij/payload-tools)
[![downloads](https://img.shields.io/npm/dt/payload-openapi?color=blue)](https://www.npmjs.com/package/payload-openapi)
[![npm version](https://badge.fury.io/js/payload-openapi.svg)](https://www.npmjs.com/package/payload-openapi)
[![license](https://img.shields.io/npm/l/payload-openapi?color=blue)](https://img.shields.io/npm/l/payload-openapi)

# payload-openapi

Generate openapi 3 documentation for your [payload cms](https://payloadcms.com).

`payload-openapi` documents ALL your payload openapi endpoints and includes:

- collection endpoints
- global endpoints
- custom endpoints
- authentication endpoints
- preferences endpoints
- fully typed schema definitions for all requests, parameters and responses
- authentication requirements for all your endpoints
- extension points to merge your custom openapi definitions into the schema

Alternatives:

- [payload-swagger](https://www.npmjs.com/package/payload-swagger) if you want to publish the openapi document with a swagger UI
- [create-payload-api-docs](https://www.npmjs.com/package/create-payload-api-docs) if you want a cli version

## Installation

With yarn:

```shell
yarn add payload-openapi
```

With npm:

```shell
npm install payload-openapi
```

## Usage

`payload-openapi` creates openAPI documents, version 3.0, as javascript object. If you need a yaml file, please use a library like `yaml` to convert it.

```typescript
import { createDocument } from 'payload-swagger';
import payloadConfig from '...';

const openapiDocument = createDocument(payloadConfig, {
  /* see options section */
});
```

## Extend the openAPI document

The openapi document generated by `payload-openapi` includes information from the following external sources:

- `package.json`: `payload-openapi` uses the information in the fields shown below. In `openapi` a partial openapi document can be included;

```json
{
  "name": "my payload cms",
  "version": "1.2.3",
  "description": "My awesome cms",
  "license": "MIT",
  "openapi": {}
}
```

- `.openapi`: optional file with partial openapi document in JSON format.

The data from all these source is recursively merged into the final document.

## Options

`payload-openapi` has the following options:

```typescript
interface Options {
  /**
   * By default the access functions on all collections in the config are called to determine
   * the access level of the operations.
   * Provide an array of collection slugs to disable this for the given collections,
   * or `true` to disable for all.
   */
  disableAccessAnalysis?: boolean | string[];
  /**
   * Exclude parts of the payload config from document generation
   */
  exclude?: {
    authPaths?: boolean;
    authCollection?: boolean;
    passwordRecovery: boolean; // default true, set to `false` to include
    preferences?: boolean; // default true, set to `false` to include
    custom?: boolean;
  };
}
```

## Schema names

By default the schema name is derived from the global / collection `slug`. If the collection has a value for `label.{singular/plural}.openapi` or the global a value for `label.openapi`, that value is used instead.

```ts
import { CollectionConfig } from 'payload/types';

const Media: CollectionConfig = {
  slug: 'posts',
  labels: {
    singular: { openapi: 'post' },
    plural: { openapi: 'posts' },
  },
  // ... Rest of collection config
};
```

## Descriptions

Endpoint descriptions and summaries are generated from the `description` and `label`/`labels.{singular/plural}` fields of your globals and collections. If a multilanguage (`Record<string, string>`) value is found, the order of priority for picking the language is as follows:

- docs
- en
- first value found that is a string

This makes it possible to set a custom description for the docs:

```ts
import { CollectionConfig } from 'payload/types';

const Media: CollectionConfig = {
  slug: 'media',
  admin: {
    description: {
      docs: 'Description used in openapi docs',
      en: 'Description used in the admin panel',
    },
  },
  labels: {
    singular: 'Single value used everywhere',
    plural: {
      docs: 'Plural value used in docs',
      en: 'Plural value used in admin panel',
    },
  },
  // ... Rest of collection config
};
```

## Excluding unused endpoints

In Payload `collections` and `globals` have a standard set of available endpoints. In some situations you might not want to use some of these endpoints. In those situations you probably have used an access method that looks something like this: `() => false;`. This blocks all traffic, but the endpoint is still part of the openapi documentation.

To also remove the endpoint from the openapi documentation, you can use [payload-rbac](https://www.npmjs.com/package/payload-rbac):

```ts
import { CollectionConfig } from 'payload/types';
import { blockAll } from 'payload-rbac';

const Media: CollectionConfig: {
  slug: 'media',
  access: {
    delete: blockAll(), // Use block all to exclude endpoint from docs
  },
  // ... Rest of collection config
}
```

## Version history

See [changelog](./CHANGELOG.md)
